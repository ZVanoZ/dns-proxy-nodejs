# Memory Bank: System Patterns

## Архитектурные паттерны

### Модульная структура
Проект организован в модули:
- `App/` - основная логика приложения
- `Logger/` - система логирования
- `Test/` - тестовые утилиты

### Загрузка конфигурации
- Конфигурация загружается из INI файлов через `OptionsLoader`
- Поддержка различных окружений (DEV/PROD)
- Настройка через `config/app.ini`

### Инициализация приложения
```typescript
1. Создание Logger через LoggerFactory
2. Создание экземпляра App
3. Загрузка опций из INI файла
4. Установка опций в App
5. Запуск приложения
```

### Логирование
- Фабрика логгеров (`LoggerFactory`)
- Ротация логов (`LogRotationService`)
- Форматирование логов (`LogFormatter`)
- Переупорядочивание потоков (`LogReorderStream`)

### Обработка ошибок
- Асинхронная инициализация с обработкой ошибок
- Выход из процесса при критических ошибках
- Логирование ошибок через структурированный логгер

## Паттерны проектирования

### Factory Pattern
- `LoggerFactory` - создание экземпляров логгеров
- `OptionsLoader` - загрузка конфигурации

### Service Pattern
- `LogRotationService` - сервис ротации логов
- `App` - основной сервис приложения

### Stream Pattern
- `LogReorderStream` - обработка потоков логов

## Принципы разработки

### Объектно-Ориентированное Программирование (ООП)
- **Основной подход** для всего кода приложения
- Использование классов для организации логики:
  - `App` - основной класс приложения
  - `LoggerFactory` - фабрика для создания логгеров
  - `RotatingLogger` - класс для ротации логов
  - `LogRotationService` - сервис ротации
  - `Options` - класс конфигурации
  - `OptionsLoader` - загрузчик конфигурации
- Инкапсуляция через модификаторы доступа (`protected`, `private`, `public`)
- **Исключение**: Unit-тесты используют функциональный подход через Jest (стандартная практика)

### Строгая типизация (ОБЯЗАТЕЛЬНОЕ ТРЕБОВАНИЕ)
- **Использование строгой типизации обязательно** во всех `*.ts` файлах проекта
- Использование TypeScript strict mode
- Все переменные, параметры функций и возвращаемые значения должны иметь явные типы
- Запрещено использование `any` без явной необходимости и обоснования
- Использование `unknown` вместо `any` при необходимости работы с неизвестными типами
- Дополнительные строгие проверки:
  - Проверка индексов массивов (noUncheckedIndexedAccess)
  - Точные опциональные типы (exactOptionalPropertyTypes)

### Модульность
- Разделение ответственности между модулями
- Четкие интерфейсы между компонентами
- ESM модули (import/export)

### Конфигурируемость
- Настройка через внешние файлы
- Поддержка различных окружений (DEV/PROD)

## Паттерны работы с Cursor AI

### Автоматическое журналирование чатов
**Методология:** vanzan01/cursor-memory-bank v0.8  
**Реализация:** Правило автоматического журналирования реализовано в `.cursor/rules/isolation_rules/Core/chat-logging.mdc`

#### Правила журналирования

1. **Создание файла журнала при создании чата**
   - При каждом создании нового чата создается пустой файл для журнала
   - **Шаблон пути:** `./docs/prompt/<YYYY>/<YYYY-MM-DD>/<HH24-MM>/chat.md`
   - Временные метки формируются на основании момента времени по Гринвичу (GMT/UTC)
   - Пример пути: `./docs/prompt/2026/2026-01-16/14-30/chat.md` (для чата, созданного 16 января 2026 года в 14:30 UTC)
   - Файл создается автоматически AI при первом запросе в чате согласно правилу `chat-logging.mdc`
   - **ОБЯЗАТЕЛЬНО** записывается режим работы для КАЖДОГО запроса отдельно (не в заголовок)

2. **Экспорт чата при запросах**
   - При **старте** каждого запроса выполняется экспорт всего чата в файл с полной заменой содержимого
   - При **завершении** каждого запроса выполняется экспорт всего чата в файл с полной заменой содержимого
   - Файл журнала всегда содержит актуальное состояние всего чата
   - Экспорт выполняется автоматически AI согласно правилу `chat-logging.mdc`

#### Формат файла журнала
- Файл содержит полный экспорт чата в формате Markdown
- При каждом экспорте содержимое файла полностью заменяется
- Структура файла должна включать все сообщения чата с временными метками
- Формат временных меток: `YYYY-MM-DD HH24:MI:SS GMT`
- Каждый запрос отделяется разделителем `---` и заголовком `## Запрос: <время GMT>`
- **Заголовок файла содержит:**
  - Время создания чата: `Чат создан: <YYYY-MM-DD HH24:MI:SS GMT>`
- **Каждый запрос содержит:**
  - Заголовок запроса: `## Запрос: <время GMT>`
  - Режим работы для этого запроса: `Режим работы: <Ask mode / Agent mode / другой режим>`
  - Текст запроса пользователя
  - Текст ответа AI
- Разные запросы в одном чате могут иметь разные режимы работы

#### Техническая реализация

**Правило Cursor AI:**
- Файл: `.cursor/rules/isolation_rules/Core/chat-logging.mdc`
- Статус: `alwaysApply: true` - применяется ко всем чатам автоматически
- Описание: Содержит детальные инструкции для AI по созданию и обновлению файлов журнала

**Алгоритм работы:**
1. При первом запросе в чате AI автоматически:
   - Создает файл журнала по пути `./docs/prompt/<YYYY>/<YYYY-MM-DD>/<HH24-MM>/chat.md`
   - Записывает в заголовок время создания чата (без режима работы)
2. При начале каждого запроса AI:
   - Определяет режим работы для текущего запроса (Ask mode / Agent mode / другой режим)
   - Для каждого предыдущего запроса определяет его режим работы (если не был определен ранее)
   - Экспортирует текущее состояние чата в файл с указанием режима работы для каждого запроса (полная замена)
3. При завершении каждого запроса AI:
   - Определяет режим работы для текущего запроса
   - Для каждого предыдущего запроса определяет его режим работы (если не был определен ранее)
   - Экспортирует обновленное состояние чата в файл с указанием режима работы для каждого запроса (полная замена)

**Требования:**
- Все временные метки в формате GMT/UTC
- **ОБЯЗАТЕЛЬНО** записывать режим работы для КАЖДОГО запроса отдельно (не в заголовок)
- Автоматическое создание директорий если не существуют
- Полная замена содержимого файла при каждом экспорте (не добавление)
- Форматирование в Markdown с разделителями между запросами
- Режим работы для каждого запроса определяется на основе доступных инструментов и возможностей AI в момент обработки этого запроса
- Разные запросы в одном чате могут иметь разные режимы работы

## База знаний

### DNS спецификация

**Knowledge Base:** DNS specifications are located in `/docs/reference/dns/` and should be referenced during protocol implementation.

Документация по протоколу DNS находится в `docs/reference/dns/` и включает:
- `/docs/reference/dns/README.md` - главная страница документации
- `/docs/reference/dns/01-basics.md` - основы DNS
- `/docs/reference/dns/02-packet-structure.md` - структура DNS пакета
- `/docs/reference/dns/03-record-types.md` - типы DNS записей
- `/docs/reference/dns/04-resolution-process.md` - процесс резолвинга
- `/docs/reference/dns/05-server-types.md` - типы DNS серверов
- `/docs/reference/dns/06-response-codes.md` - коды ответов DNS

При работе с логикой DNS всегда учитывай документацию в папке `docs/reference/dns/`.
