# Использование профилей для разделения DEV и PROD
# Запуск DEV:  docker compose --profile dev up
# Запуск PROD: docker compose --profile prod up
# Или через npm: npm run docker:dev / npm run docker:prod

services:
  dns-proxy-dev:
    profiles:
      - dev
    build:
      context: .
      dockerfile: ./env/dev/Dockerfile
    container_name: dns-proxy-dev
    ports:
      - "5053:53/udp"
    volumes:
      - ./src:/app/src
      - ./env/dev/config:/app/config
      - ./dist:/app/dist
      - ./env/dev/logs:/app/logs
      - ./scripts:/app/scripts
      - ./env/dev/.env:/app/.run-dev.env
    environment:
      - NODE_ENV=development
      - APP_INI_PATH=/app/config/app.ini
    env_file:
      - env/dev/.env
    command: npx tsx --inspect src/main.ts
    restart: unless-stopped
    networks:
      default:
        ipv4_address: ${DEV_SERVER_IP}
        ipv6_address: ${DEV_SERVER_IPV6:-fd00:0:0:1::133}

  dns-proxy-prod:
    profiles:
      - prod
    build:
      context: .
      dockerfile: ./env/prod/Dockerfile
    container_name: dns-proxy-prod
    ports:
      - "53:5053/udp"
    volumes:
      - ./dist:/app/dist
      - ./env/prod/config:/app/config
      - ./env/prod/logs:/app/logs
      - ./scripts:/app/scripts
    environment:
      - APP_INI_PATH=/app/config/app.ini
    env_file:
      - env/prod/.env
    command: node dist/app.js
    restart: always
    networks:
      default:
        ipv4_address: ${PROD_SERVER_IP}
        ipv6_address: ${PROD_SERVER_IPV6:-fd00:0:0:1::13}

networks:
  default:
    name: dns-proxy-nodejs-net
    driver: bridge
    enable_ipv6: true
    ipam:
      config:
        - subnet: ${NETWORK_SUBNET}
        - subnet: ${NETWORK_SUBNET_IPV6:-fd00:0:0:1::/80}