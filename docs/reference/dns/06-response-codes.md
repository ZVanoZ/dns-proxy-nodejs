# DNS коды ответов (Response Codes)

DNS серверы возвращают различные коды ответов (RCODE) в зависимости от результата запроса. В этом разделе мы рассмотрим все основные коды.

## Что такое RCODE?

**RCODE (Response Code)** — это 4-битное поле в заголовке DNS пакета, которое указывает результат обработки запроса. RCODE находится в поле флагов заголовка DNS пакета.

## Стандартные коды ответов (RFC 1035)

### NOERROR (0) — Нет ошибки

**Значение:** Запрос успешно обработан.

**Когда возвращается:**
- Домен найден и возвращены запрошенные записи
- Домен найден, но запрошенных записей нет (но есть другие записи)

**Пример:**
```
Запрос: example.com (тип A)
Ответ: RCODE=0, A запись: 93.184.216.34
```

**RFC:** RFC 1035

---

### FORMERR (1) — Ошибка формата

**Значение:** DNS пакет имеет неправильный формат.

**Когда возвращается:**
- Заголовок пакета некорректен
- Структура пакета не соответствует спецификации
- Неправильное кодирование доменного имени

**Пример:**
```
Запрос: Некорректный формат пакета
Ответ: RCODE=1 (FORMERR)
```

**Что делать:**
- Проверить формат DNS пакета
- Убедиться, что кодирование доменного имени корректно

**RFC:** RFC 1035

---

### SERVFAIL (2) — Ошибка сервера

**Значение:** Сервер не смог обработать запрос из-за внутренней ошибки.

**Когда возвращается:**
- Авторитативный сервер недоступен
- Ошибка при чтении зоны
- Проблемы с базой данных DNS
- Временная недоступность сервера

**Пример:**
```
Запрос: example.com (тип A)
Ответ: RCODE=2 (SERVFAIL)
```

**Что делать:**
- Повторить запрос позже
- Проверить доступность авторитативного сервера
- Обратиться к администратору DNS сервера

**RFC:** RFC 1035

---

### NXDOMAIN (3) — Домен не найден

**Значение:** Запрашиваемый домен не существует.

**Когда возвращается:**
- Домен не зарегистрирован
- Домен удален
- Домен никогда не существовал

**Пример:**
```
Запрос: nonexistent-domain-12345.com (тип A)
Ответ: RCODE=3 (NXDOMAIN)
```

**Важно:**
- Это **не ошибка** в смысле технической проблемы
- Это нормальный ответ для несуществующего домена
- Отрицательные ответы кэшируются (обычно 5-15 минут)

**RFC:** RFC 1035

---

### NOTIMP (4) — Не реализовано

**Значение:** Сервер не поддерживает запрошенный тип запроса.

**Когда возвращается:**
- Запрошен неподдерживаемый Opcode
- Сервер не реализует определенную функциональность

**Пример:**
```
Запрос: Статус сервера (Opcode=2)
Ответ: RCODE=4 (NOTIMP) - если сервер не поддерживает STATUS запросы
```

**Примечание:** В современном DNS этот код редко используется, так как большинство серверов поддерживают стандартные запросы.

**RFC:** RFC 1035

---

### REFUSED (5) — Отклонено

**Значение:** Сервер отклонил запрос по политическим причинам.

**Когда возвращается:**
- Сервер не обслуживает запросы от данного клиента
- Запрос заблокирован политикой безопасности
- Зона не обслуживается на этом сервере

**Пример:**
```
Запрос: example.com от неавторизованного клиента
Ответ: RCODE=5 (REFUSED)
```

**Что делать:**
- Проверить настройки доступа к серверу
- Убедиться, что запрос отправляется правильному серверу

**RFC:** RFC 1035

---

## Расширенные коды ответов (EDNS0)

С введением EDNS0 (RFC 6891) появились дополнительные коды ответов:

### BADVERS/BADSIG (16) — Неверная версия EDNS

**Значение:** Сервер не поддерживает версию EDNS, указанную в запросе.

**RFC:** RFC 6891

---

### BADKEY (17) — Неверный ключ

**Значение:** Используется в DNSSEC для указания на проблему с ключом.

**RFC:** RFC 4035

---

### BADTIME (18) — Неверное время

**Значение:** Используется в DNSSEC для указания на проблему со временем подписи.

**RFC:** RFC 4035

---

### BADMODE (19) — Неверный режим

**Значение:** Используется в DNSSEC для указания на проблему с режимом.

**RFC:** RFC 4035

---

### BADNAME (20) — Неверное имя

**Значение:** Используется в DNSSEC для указания на проблему с именем.

**RFC:** RFC 4035

---

### BADALG (21) — Неверный алгоритм

**Значение:** Используется в DNSSEC для указания на проблему с алгоритмом подписи.

**RFC:** RFC 4035

---

### BADTRUNC (22) — Неверная обрезка

**Значение:** Используется в DNSSEC для указания на проблему с обрезкой данных.

**RFC:** RFC 4035

---

## Таблица кодов ответов

| Код | Название | Описание | RFC |
|-----|----------|-----------|-----|
| 0 | NOERROR | Нет ошибки | RFC 1035 |
| 1 | FORMERR | Ошибка формата | RFC 1035 |
| 2 | SERVFAIL | Ошибка сервера | RFC 1035 |
| 3 | NXDOMAIN | Домен не найден | RFC 1035 |
| 4 | NOTIMP | Не реализовано | RFC 1035 |
| 5 | REFUSED | Отклонено | RFC 1035 |
| 6-15 | (Зарезервировано) | - | RFC 1035 |
| 16 | BADVERS/BADSIG | Неверная версия EDNS | RFC 6891 |
| 17 | BADKEY | Неверный ключ (DNSSEC) | RFC 4035 |
| 18 | BADTIME | Неверное время (DNSSEC) | RFC 4035 |
| 19 | BADMODE | Неверный режим (DNSSEC) | RFC 4035 |
| 20 | BADNAME | Неверное имя (DNSSEC) | RFC 4035 |
| 21 | BADALG | Неверный алгоритм (DNSSEC) | RFC 4035 |
| 22 | BADTRUNC | Неверная обрезка (DNSSEC) | RFC 4035 |
| 23-3840 | (Зарезервировано) | - | - |
| 3841-4095 | (Приватное использование) | - | - |

## Интерпретация кодов в приложениях

### Успешные ответы

- **NOERROR (0)** — запрос успешен, можно использовать ответ

### Ошибки клиента

- **NXDOMAIN (3)** — домен не существует (нормальная ситуация)
- **FORMERR (1)** — ошибка в формате запроса (проблема клиента)

### Ошибки сервера

- **SERVFAIL (2)** — временная ошибка сервера, стоит повторить запрос
- **REFUSED (5)** — сервер отклонил запрос
- **NOTIMP (4)** — сервер не поддерживает запрос

## Примеры использования

### Проверка существования домена

```bash
# Запрос к несуществующему домену
$ dig nonexistent-domain-12345.com

# Ответ:
# ;; ->>HEADER<<- opcode: QUERY, status: NXDOMAIN, id: 12345
# status: NXDOMAIN означает, что домен не найден
```

### Проверка доступности сервера

```bash
# Запрос к недоступному серверу
$ dig @unreachable-server.com example.com

# Ответ:
# ;; ->>HEADER<<- opcode: QUERY, status: SERVFAIL, id: 12345
# status: SERVFAIL означает ошибку сервера
```

### Успешный запрос

```bash
# Запрос к существующему домену
$ dig google.com

# Ответ:
# ;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 12345
# status: NOERROR означает успешный ответ
```

## Обработка кодов в коде

### Пример на Python

```python
import dns.resolver

try:
    answer = dns.resolver.resolve('example.com', 'A')
    # RCODE = NOERROR (0)
    for rdata in answer:
        print(rdata)
except dns.resolver.NXDOMAIN:
    # RCODE = NXDOMAIN (3)
    print("Домен не найден")
except dns.resolver.NoAnswer:
    # RCODE = NOERROR, но нет записей запрошенного типа
    print("Нет A записей")
except dns.exception.DNSException as e:
    # Другие ошибки DNS
    print(f"Ошибка DNS: {e}")
```

### Пример на JavaScript/Node.js

```javascript
const dns = require('dns');

dns.resolve4('example.com', (err, addresses) => {
    if (err) {
        if (err.code === 'ENOTFOUND') {
            // Эквивалент NXDOMAIN
            console.log('Домен не найден');
        } else if (err.code === 'ESERVFAIL') {
            // Эквивалент SERVFAIL
            console.log('Ошибка сервера');
        } else {
            console.log('Другая ошибка:', err.message);
        }
    } else {
        // Успешный ответ (NOERROR)
        console.log('IP адреса:', addresses);
    }
});
```

## Кэширование ответов с ошибками

### Отрицательное кэширование

Ошибки также кэшируются для уменьшения нагрузки:

- **NXDOMAIN** — кэшируется на 5-15 минут (зависит от настроек)
- **SERVFAIL** — кэшируется на короткое время (обычно 30 секунд - 5 минут)
- **REFUSED** — обычно не кэшируется

**RFC:** RFC 2308 — Negative Caching of DNS Queries (DNS NCACHE)

## Ссылки на RFC

- **RFC 1035** — Domain Names — Implementation and Specification — стандартные коды ответов
- **RFC 2308** — Negative Caching of DNS Queries (DNS NCACHE) — отрицательное кэширование
- **RFC 4035** — Protocol Modifications for the DNS Security Extensions — коды DNSSEC
- **RFC 6891** — Extension Mechanisms for DNS (EDNS0) — расширенные коды

## Следующие шаги

Теперь, когда вы понимаете коды ответов, вы можете:
- Правильно обрабатывать различные ответы DNS в своих приложениях
- Диагностировать проблемы с DNS
- Понимать логи DNS серверов

Вернуться к [основной документации](README.md) для изучения других аспектов DNS.
