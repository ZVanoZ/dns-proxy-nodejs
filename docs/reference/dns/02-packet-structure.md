# Структура DNS пакета

DNS запросы и ответы передаются в виде бинарных пакетов по протоколу UDP (реже TCP). В этом разделе мы разберем структуру DNS пакета.

## Общая структура DNS пакета

DNS пакет состоит из следующих частей:

```
┌─────────────────────────────────────┐
│         Заголовок (Header)          │  12 байт
├─────────────────────────────────────┤
│         Вопросы (Questions)          │  Переменная длина
├─────────────────────────────────────┤
│         Ответы (Answers)             │  Переменная длина
├─────────────────────────────────────┤
│      Авторитативные записи (Authority)│  Переменная длина
├─────────────────────────────────────┤
│      Дополнительные записи (Additional)│  Переменная длина
└─────────────────────────────────────┘
```

## Заголовок DNS пакета (Header)

Заголовок всегда занимает 12 байт и содержит метаданные о запросе/ответе:

```
 0  1  2  3  4  5  6  7  8  9  A  B  C  D  E  F
+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+
|                      ID                       |  2 байта
+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+
|QR|   Opcode  |AA|TC|RD|RA|   Z    |   RCODE   |  2 байта
+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+
|                    QDCOUNT                    |  2 байта
+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+
|                    ANCOUNT                    |  2 байта
+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+
|                    NSCOUNT                    |  2 байта
+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+
|                    ARCOUNT                    |  2 байта
+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+
```

### Поля заголовка

#### ID (Identifier) — 2 байта
- Уникальный идентификатор запроса
- Используется для сопоставления запроса и ответа
- Клиент генерирует случайное число, сервер возвращает то же число в ответе

#### Флаги (Flags) — 2 байта

**QR (Query/Response)** — 1 бит
- `0` = Запрос (Query)
- `1` = Ответ (Response)

**Opcode** — 4 бита
- `0` = Стандартный запрос (QUERY)
- `1` = Обратный запрос (IQUERY) — устарел
- `2` = Статус сервера (STATUS)
- `3-15` = Зарезервировано

**AA (Authoritative Answer)** — 1 бит
- `1` = Ответ от авторитативного сервера
- `0` = Ответ от неавторитативного сервера (кэшированный)

**TC (Truncated)** — 1 бит
- `1` = Пакет обрезан (слишком большой для UDP)
- `0` = Пакет не обрезан

**RD (Recursion Desired)** — 1 бит
- `1` = Клиент просит рекурсивный запрос
- `0` = Клиент не просит рекурсию

**RA (Recursion Available)** — 1 бит
- `1` = Сервер поддерживает рекурсивные запросы
- `0` = Сервер не поддерживает рекурсию

**Z (Reserved)** — 3 бита
- Зарезервировано, должно быть `0`

**RCODE (Response Code)** — 4 бита
- `0` = Нет ошибки (NOERROR)
- `1` = Ошибка формата (FORMERR)
- `2` = Ошибка сервера (SERVFAIL)
- `3` = Имя не найдено (NXDOMAIN)
- `4` = Не реализовано (NOTIMP)
- `5` = Отклонено (REFUSED)
- `6-15` = Дополнительные коды

#### Счетчики — по 2 байта каждый

**QDCOUNT** — количество вопросов в секции Questions
**ANCOUNT** — количество записей в секции Answers
**NSCOUNT** — количество записей в секции Authority
**ARCOUNT** — количество записей в секции Additional

## Секция Questions (Вопросы)

Содержит вопросы, на которые нужно ответить. Каждый вопрос имеет структуру:

```
+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+
|                                               |
/                     QNAME                     /
/                                               /
+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+
|                     QTYPE                     |  2 байта
+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+
|                     QCLASS                    |  2 байта
+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+
```

### Поля вопроса

**QNAME** — доменное имя в специальном формате:
- Каждая часть домена предваряется байтом с длиной этой части
- Заканчивается нулевым байтом
- Пример: `www.example.com` кодируется как `\x03www\x07example\x03com\x00`

**QTYPE** — тип запрашиваемой записи:
- `1` = A (IPv4 адрес)
- `2` = NS (Name Server)
- `5` = CNAME (Canonical Name)
- `15` = MX (Mail Exchange)
- `28` = AAAA (IPv6 адрес)
- `255` = ANY (любой тип)

**QCLASS** — класс запроса:
- `1` = IN (Internet) — почти всегда используется этот класс

## Секция Answers (Ответы)

Содержит ответы на вопросы. Каждая запись имеет структуру:

```
+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+
|                                               |
/                                               /
/                      NAME                     /
|                                               |
+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+
|                      TYPE                     |  2 байта
+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+
|                     CLASS                     |  2 байта
+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+
|                      TTL                      |  4 байта
|                                               |
+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+
|                   RDLENGTH                    |  2 байта
+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--|
/                     RDATA                     /
/                                               /
+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+--+
```

### Поля записи ответа

**NAME** — доменное имя (может использовать сжатие указателей)
**TYPE** — тип записи (те же значения, что и QTYPE)
**CLASS** — класс записи (обычно `1` = IN)
**TTL** — время жизни записи в секундах
**RDLENGTH** — длина данных RDATA в байтах
**RDATA** — данные записи (зависят от типа)

## Сжатие указателей (Pointer Compression)

Для экономии места в пакете DNS использует сжатие указателей. Если доменное имя уже встречалось в пакете, вместо полного имени используется указатель (2 байта):

- Первые 2 бита = `11` (признак указателя)
- Остальные 14 бит = смещение от начала пакета

Пример: если `example.com` уже было в пакете на позиции 12, то указатель будет `0xC00C` (1100 0000 0000 1100).

## Пример DNS запроса

Запрос для `www.example.com` типа A:

```
Заголовок:
  ID: 0x1234
  QR: 0 (запрос)
  Opcode: 0 (стандартный запрос)
  RD: 1 (рекурсия желательна)
  QDCOUNT: 1

Вопрос:
  QNAME: \x03www\x07example\x03com\x00
  QTYPE: 1 (A)
  QCLASS: 1 (IN)
```

## Пример DNS ответа

Ответ с IP-адресом `93.184.216.34`:

```
Заголовок:
  ID: 0x1234 (тот же, что в запросе)
  QR: 1 (ответ)
  AA: 1 (авторитативный ответ)
  RA: 1 (рекурсия доступна)
  ANCOUNT: 1

Ответ:
  NAME: \x03www\x07example\x03com\x00
  TYPE: 1 (A)
  CLASS: 1 (IN)
  TTL: 3600
  RDLENGTH: 4
  RDATA: 93.184.216.34 (в виде 4 байт)
```

## Протоколы передачи

### UDP (User Datagram Protocol)
- **Порт:** 53
- **Используется по умолчанию** для большинства запросов
- Максимальный размер пакета: 512 байт (без EDNS0)
- Быстрый, но без гарантии доставки

### TCP (Transmission Control Protocol)
- **Порт:** 53
- Используется когда:
  - Пакет больше 512 байт (флаг TC установлен)
  - Для зонных трансферов (AXFR/IXFR)
  - Когда требуется надежная доставка
- Медленнее, но надежнее

## EDNS0 (Extension Mechanisms for DNS)

Расширение DNS, позволяющее:
- Увеличить максимальный размер пакета (до 4096 байт и более)
- Передавать дополнительную информацию
- Описывается в **RFC 6891**

## Ссылки на RFC

- **RFC 1035** — Domain Names — Implementation and Specification — основная спецификация структуры пакета
- **RFC 6891** — Extension Mechanisms for DNS (EDNS0) — расширения DNS

## Следующие шаги

Теперь, когда вы понимаете структуру пакета, изучите:
- [Типы DNS записей](03-record-types.md) — что хранится в RDATA
- [Процесс резолвинга DNS](04-resolution-process.md) — как используются пакеты
