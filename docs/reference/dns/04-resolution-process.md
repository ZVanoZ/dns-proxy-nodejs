# Процесс резолвинга DNS

Резолвинг DNS — это процесс преобразования доменного имени в IP-адрес. В этом разделе мы подробно разберем, как это происходит.

## Типы резолвинга

### Рекурсивный резолвинг (Recursive Resolution)

Клиент отправляет запрос рекурсивному резолверу, который **полностью** выполняет поиск и возвращает окончательный ответ.

**Преимущества:**
- Клиенту не нужно знать структуру DNS
- Резолвер кэширует ответы для ускорения
- Упрощает работу клиентских приложений

**Процесс:**
```
Клиент → Рекурсивный резолвер → [выполняет весь поиск] → Клиент
```

### Итеративный резолвинг (Iterative Resolution)

Клиент сам выполняет поиск, получая от каждого сервера ссылку на следующий сервер.

**Процесс:**
```
Клиент → Корневой сервер → TLD сервер → Авторитативный сервер → Клиент
```

## Детальный процесс рекурсивного резолвинга

Давайте проследим, что происходит при запросе `www.example.com`:

### Шаг 1: Запрос от клиента

```
Клиент (ваш компьютер)
  ↓
"Где находится www.example.com?"
  ↓
Рекурсивный резолвер (например, 8.8.8.8)
```

**Что происходит:**
- Ваш компьютер отправляет DNS запрос рекурсивному резолверу
- Запрос содержит: QNAME=`www.example.com`, QTYPE=A, QCLASS=IN

### Шаг 2: Проверка кэша

Резолвер сначала проверяет свой кэш:

```
Резолвер проверяет кэш:
  - Есть ли www.example.com? → НЕТ
  - Есть ли example.com? → НЕТ
  - Есть ли .com? → НЕТ
```

Если запись найдена в кэше и TTL не истек, резолвер сразу возвращает ответ.

### Шаг 3: Запрос к корневому серверу

Если в кэше нет ответа, резолвер обращается к корневому DNS серверу:

```
Рекурсивный резолвер
  ↓
"Где находится .com?"
  ↓
Корневой DNS сервер (например, a.root-servers.net)
```

**Ответ корневого сервера:**
```
.com.    IN    NS    a.gtld-servers.net.
.com.    IN    NS    b.gtld-servers.net.
.com.    IN    NS    c.gtld-servers.net.
...
```

Корневой сервер не знает, где находится `example.com`, но знает, какие серверы отвечают за `.com`.

### Шаг 4: Запрос к TLD серверу

Резолвер обращается к одному из TLD серверов для `.com`:

```
Рекурсивный резолвер
  ↓
"Где находится example.com?"
  ↓
TLD сервер (например, a.gtld-servers.net)
```

**Ответ TLD сервера:**
```
example.com.    IN    NS    ns1.example.com.
example.com.    IN    NS    ns2.example.com.
ns1.example.com.    IN    A    192.0.2.1
ns2.example.com.    IN    A    192.0.2.2
```

TLD сервер не знает IP-адрес `www.example.com`, но знает, какие серверы являются авторитативными для `example.com`.

### Шаг 5: Запрос к авторитативному серверу

Резолвер обращается к авторитативному серверу домена:

```
Рекурсивный резолвер
  ↓
"Где находится www.example.com?"
  ↓
Авторитативный сервер (например, ns1.example.com)
```

**Ответ авторитативного сервера:**
```
www.example.com.    IN    A    93.184.216.34
```

Это окончательный ответ! Авторитативный сервер знает IP-адрес `www.example.com`.

### Шаг 6: Возврат ответа клиенту

Резолвер возвращает ответ клиенту и сохраняет его в кэше:

```
Рекурсивный резолвер
  ↓
"www.example.com = 93.184.216.34"
  ↓
Клиент (ваш компьютер)
```

**Кэширование:**
- Резолвер сохраняет ответ в кэше на время TTL (например, 3600 секунд)
- Последующие запросы к `www.example.com` будут обрабатываться мгновенно из кэша

## Визуальная схема процесса

```
┌─────────┐
│ Клиент  │
└────┬────┘
     │ 1. Запрос: www.example.com?
     ↓
┌─────────────────┐
│ Рекурсивный     │
│ резолвер        │
└────┬────────────┘
     │ 2. Запрос: .com?
     ↓
┌─────────────┐
│ Корневой    │
│ сервер      │
└────┬────────┘
     │ 3. Ответ: Спроси TLD сервер
     ↓
┌─────────────┐
│ TLD сервер  │
│ (.com)      │
└────┬────────┘
     │ 4. Ответ: Спроси авторитативный сервер
     ↓
┌─────────────────┐
│ Авторитативный  │
│ сервер          │
│ (example.com)   │
└────┬────────────┘
     │ 5. Ответ: 93.184.216.34
     ↓
┌─────────────────┐
│ Рекурсивный     │
│ резолвер        │
│ (кэширует)      │
└────┬────────────┘
     │ 6. Ответ: 93.184.216.34
     ↓
┌─────────┐
│ Клиент  │
└─────────┘
```

## Особые случаи

### CNAME записи

Если запрашивается домен с CNAME записью:

```
Запрос: www.example.com (тип A)
Ответ: www.example.com IN CNAME example.com
       example.com IN A 93.184.216.34
```

Резолвер должен выполнить дополнительный запрос для разрешения CNAME.

### Несколько A записей

Домен может иметь несколько A записей для балансировки нагрузки:

```
example.com.    IN    A    93.184.216.34
example.com.    IN    A    93.184.216.35
example.com.    IN    A    93.184.216.36
```

Резолвер возвращает все записи, клиент выбирает одну (обычно случайную).

### Ошибка NXDOMAIN

Если домен не существует:

```
Запрос: nonexistent.example.com
Ответ: RCODE = NXDOMAIN (домен не найден)
```

### Ошибка SERVFAIL

Если авторитативный сервер недоступен:

```
Запрос: example.com
Ответ: RCODE = SERVFAIL (ошибка сервера)
```

## Кэширование DNS

### Зачем нужно кэширование?

Без кэширования каждый запрос требовал бы обращения к нескольким серверам, что было бы очень медленно.

### Где происходит кэширование?

1. **В браузере** — современные браузеры кэшируют DNS ответы
2. **В операционной системе** — ОС кэширует DNS ответы
3. **В рекурсивном резолвере** — резолвер кэширует ответы для всех клиентов

### TTL (Time To Live)

TTL определяет, как долго можно хранить запись в кэше:

```
example.com.    IN    A    93.184.216.34    TTL: 3600
```

Это означает, что запись можно кэшировать на 3600 секунд (1 час).

### Отрицательное кэширование

Ошибки (например, NXDOMAIN) также кэшируются на короткое время (обычно 5-15 минут), чтобы не перегружать серверы повторными запросами к несуществующим доменам.

## Оптимизации процесса

### Предварительная выборка (Prefetching)

Некоторые резолверы предварительно запрашивают часто используемые домены.

### Параллельные запросы

При запросе нескольких записей резолвер может выполнять запросы параллельно.

### EDNS0

Расширение DNS, позволяющее передавать большие пакеты и дополнительную информацию, что ускоряет процесс.

## Отладка процесса резолвинга

### Команда dig

Подробная информация о процессе резолвинга:

```bash
dig www.example.com +trace
```

Показывает весь процесс от корневого сервера до авторитативного.

### Команда nslookup

Простой способ проверить резолвинг:

```bash
nslookup www.example.com
```

### Команда host

Альтернативный способ:

```bash
host www.example.com
```

## Ссылки на RFC

- **RFC 1034** — Domain Names — Concepts and Facilities — концепции резолвинга
- **RFC 1035** — Domain Names — Implementation and Specification — технические детали
- **RFC 2308** — Negative Caching of DNS Queries (DNS NCACHE) — отрицательное кэширование

## Следующие шаги

Теперь, когда вы понимаете процесс резолвинга, изучите:
- [Типы DNS серверов](05-server-types.md) — какие серверы участвуют в процессе
- [DNS коды ответов](06-response-codes.md) — что означают различные ответы
