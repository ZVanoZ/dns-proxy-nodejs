# Запуск DNS-прокси в Linux на порту 53 без sudo

## Проблема

В Linux порты ниже 1024 (так называемые privileged ports) по умолчанию зарезервированы для пользователя root. Чтобы DNS-прокси мог занять 53-й порт под обычным пользователем без использования sudo, есть несколько стандартных способов.

## Способ 1: Использование Capabilities (Рекомендуемый)

Вместо того чтобы давать пользователю полные права root, можно дать конкретному исполняемому файлу только одну привилегию — право занимать системные порты (CAP_NET_BIND_SERVICE).

### Шаги:

1. **Назначьте права на бинарный файл:**
   Выполните эту команду один раз (от имени sudo), указав путь к вашему скомпилированному серверу:
   ```bash
   sudo setcap 'cap_net_bind_service=+ep' /path/to/your/dns_server
   ```

2. **Запустите сервер от имени обычного пользователя:**
   Теперь вы можете запускать этот файл как обычную программу:
   ```bash
   ./your_dns_server
   ```

> **⚠️ ВАЖНО:** 
> - Если вы перекомпилируете программу (замените файл), атрибут setcap слетит, и команду нужно будет выполнить снова.
> - setcap работает только с бинарными исполняемыми файлами (ELF). На обычный shell-скрипт (.sh) установить setcap нельзя.
> - Ядро считывает возможности (capabilities) именно у того файла, который оно загружает в память (у интерпретатора), а не у файла данных (скрипта).

## Способ 2: Запуск через Systemd (Для продакшн-решений)

Если вы планируете, что сервер будет работать постоянно, лучше оформить его как сервис systemd. Это позволит запускать его от имени обычного пользователя, но при старте система сама выдаст процессу нужную привилегию.

### Шаги:

1. **Создайте файл `/etc/systemd/system/mydns.service`:**
   ```ini
   [Unit]
   Description=My Custom DNS Server
   After=network.target

   [Service]
   ExecStart=/path/to/your/dns_server
   User=your_username
   # Даем право биндить порт 53
   AmbientCapabilities=CAP_NET_BIND_SERVICE
   # Опционально: запрещаем процессу получать новые привилегии
   NoNewPrivileges=true

   [Install]
   WantedBy=multi-user.target
   ```

2. **Обновите конфигурацию и запустите:**
   ```bash
   sudo systemctl daemon-reload
   sudo systemctl enable --now mydns
   ```

## Способ 3: Перенаправление портов (Workaround)

Если вы не хотите менять права файла или системные настройки, можно запустить сервер на порту, который выше 1024 (например, 5053), и перенаправить трафик с 53-го порта на него на уровне ядра.

### Шаги:

1. **Запустите сервер на порту 5053:**
   Обычный пользователь запускает сервер без всяких спецправ.

2. **Настройте перенаправление (через iptables):**
   ```bash
   sudo iptables -t nat -A PREROUTING -p udp --dport 53 -j REDIRECT --to-port 5053
   sudo iptables -t nat -A PREROUTING -p tcp --dport 53 -j REDIRECT --to-port 5053
   ```

3. **Сохраните правила iptables:**
   ```bash
   sudo mkdir -p /etc/iptables
   sudo iptables-save | sudo tee /etc/iptables/rules.v4
   ```

   Теперь все запросы, приходящие на порт 53, будут прозрачно уходить вашему серверу на порт 5053.

## Что выбрать?

- **Если вы разрабатываете и часто пересобираете программу:** используйте Способ 3 (один раз настроили iptables и забыли).
- **Если это готовый бинарный файл (на C, Go, Rust):** используйте Способ 1 (setcap).
- **Если это сервис для постоянной работы:** используйте Способ 2 (systemd).

## Использование authbind (Альтернативный способ)

Для Node.js приложений можно использовать `authbind`:

1. **Установите authbind:**
   ```bash
   sudo apt-get install authbind  # Ubuntu/Debian
   ```

2. **Настройте authbind:**
   ```bash
   sudo touch /etc/authbind/byport/53
   sudo chown your_username /etc/authbind/byport/53
   sudo chmod 755 /etc/authbind/byport/53
   ```

3. **Запустите приложение через authbind:**
   ```bash
   authbind --deep node your_dns_server.js
   ```

> **Примечание:** Этот способ работает для скриптов и интерпретируемых языков, но требует установки дополнительного пакета.
