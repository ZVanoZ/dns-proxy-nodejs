* Вопрос
```text
Я написал свой DNS сервер.
Как мне запустить его на порту 53 без sudo?
Нужно дать такую возможность пользователю "ivan". 
```

* Ответ
```text
В Linux порты ниже 1024 (так называемые privileged ports) по умолчанию 
зарезервированы для пользователя root. 
Чтобы ваш DNS-сервер мог занять 53-й порт под пользователем ivan без 
использования sudo, есть несколько стандартных способов.

Наиболее правильный и современный метод — использование 
Capabilities (возможностей) ядра Linux.

-------------------------------------------------------------------------------
-- Способ 1: Использование Capabilities (Рекомендуемый)
-----

Вместо того чтобы давать пользователю полные права root, можно дать конкретному 
исполняемому файлу только одну привилегию — право занимать системные 
порты (CAP_NET_BIND_SERVICE).
Шаги:

    Назначьте права на бинарный файл: Выполните эту команду один раз (от имени sudo), 
    указав путь к вашему скомпилированному серверу:
    Bash

sudo setcap 'cap_net_bind_service=+ep' /home/ivan/my_dns_server

Запустите сервер от имени пользователя ivan: Теперь Иван может запускать этот 
файл как обычную программу:
Bash

    # Выполняется пользователем ivan
    ./my_dns_server

    [!WARNING] Важно: Если вы перекомпилируете программу (замените файл), атрибут 
    setcap слетит, и команду нужно будет выполнить снова. 
    Также это не сработает со скриптами (Python, JS) напрямую — права нужно 
    давать интерпретатору, что небезопасно.
    --
    На обычный shell-скрипт (.sh) установить setcap нельзя.
    setcap работает только с бинарными исполняемыми файлами (ELF).
    Ядро считывает возможности (capabilities) именно у того файла, который оно 
    загружает в память (у интерпретатора), а не у файла данных (скрипта).

-------------------------------------------------------------------------------
-- Способ 2: Запуск через Systemd (Для продакшн-решений)

Если вы планируете, что сервер будет работать постоянно, лучше оформить его как 
сервис systemd. Это позволит запускать его от имени пользователя ivan, но при 
старте система сама выдаст процессу нужную привилегию.
Шаги:

    Создайте файл /etc/systemd/system/mydns.service:
    Ini, TOML

[Unit]
Description=My Custom DNS Server
After=network.target

[Service]
ExecStart=/home/ivan/my_dns_server
# Указываем пользователя
User=ivan
# Даем право биндить порт 53
AmbientCapabilities=CAP_NET_BIND_SERVICE
# Опционально: запрещаем процессу получать новые привилегии
NoNewPrivileges=true

[Install]
WantedBy=multi-user.target

Обновите конфигурацию и запустите:
Bash

    sudo systemctl daemon-reload
    sudo systemctl enable --now mydns

-------------------------------------------------------------------------------
-- Способ 3: Перенаправление портов (Workaround)

Если вы не хотите менять права файла или системные настройки, можно запустить 
сервер на порту, который выше 1024 (например, 5353), и перенаправить 
трафик с 53-го порта на него на уровне ядра.

    Запустите сервер на порту 5353: ivan запускает сервер без всяких спецправ.

    Настройте перенаправление (через iptables или nftables):
    Bash

    sudo iptables -t nat -A PREROUTING -p udp --dport 53 -j REDIRECT --to-port 5353
    sudo iptables -t nat -A PREROUTING -p tcp --dport 53 -j REDIRECT --to-port 5353

    Теперь все запросы, приходящие на порт 53, будут прозрачно уходить вашему 
    серверу на порт 5353.

-------------------------------------------------------------------------------
-- Что выбрать?
-----

    Если вы разрабатываете и часто пересобираете программу: 
        используйте Способ 3 (один раз настроили iptables и забыли).

    Если это готовый бинарный файл (на C, Go, Rust): используйте Способ 1 (setcap).

    Если это сервис для постоянной работы: используйте Способ 2 (systemd).

Хотите, чтобы я помог составить скрипт для автоматического 
обновления setcap после каждой компиляции?



```

* Разворачиваем "Способ 2: Запуск через Systemd (Для продакшн-решений)"

```shell
sudo touch /etc/authbind/byport/53
```

```shell
sudo chown ivan /etc/authbind/byport/53
```

```shell
sudo chmod 755 /etc/authbind/byport/53
```

```shell
chmod +x run-app.sh
```
```shell
#authbind --deep ./run-app.sh
authbind --deep bash run-app.sh
```