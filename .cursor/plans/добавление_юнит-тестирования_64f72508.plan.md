---
name: ""
overview: ""
todos: []
---

# План добавления юнит-тестирования

## Цель

Добавить систему юнит-тестирования для DNS-прокси с двумя тестами: проверка доступности DNS-сервера и нагрузочный тест.

## Структура изменений

### 1. Установка зависимостей

- Добавить `jest`, `@jest/globals`, `@types/jest` в `devDependencies`
- Настроить Jest для работы с ESM и TypeScript (через `tsx` или `ts-jest`)

### 2. Конфигурация Jest

Создать `jest.config.mjs`:

- Настройка для ESM модулей (`type: "module"`)
- Поддержка TypeScript через `tsx` или `ts-jest`
- Указание путей к тестам (`src/**/*.test.ts` или `tests/**/*.test.ts`)

### 3. Конфигурационный файл для тестов

Создать `config/test.config.ini` (по аналогии с `app.ini`):

```ini
[test]
# IP адрес тестируемого DNS-сервера
dnsServerHost=127.0.0.1
# Порт тестируемого DNS-сервера
dnsServerPort=5053
# Приблизительное количество DNS-запросов в секунду на компьютере веб-разработчика
# Значение основано на статистике: при активной разработке 30-50 запросов/сек
requestsPerSecond=40
# Длительность нагрузочного теста в секундах
loadTestDuration=10
# Домены для тестирования (через запятую)
testDomains=google.com,github.com,example.com
```

Создать `config/test.config.ini.dist` как шаблон.

### 4. Загрузчик опций для тестов

Создать `src/Test/TestOptionsLoader.ts`:

- Функция `loadTestOptions()` для загрузки опций из `config/test.config.ini`
- Использовать существующий механизм парсинга INI (как в `OptionsLoader.ts`)
- Тип `TestOptions` с полями: `dnsServerHost`, `dnsServerPort`, `requestsPerSecond`, `loadTestDuration`, `testDomains`

### 5. Тест доступности DNS-сервера

Создать `src/App/App.test.ts` или `tests/App.test.ts`:

- Тест `should be accessible` - отправка DNS-запроса на тестируемый сервер
- Использовать `dns-packet` для формирования запроса
- Использовать `dgram` для отправки UDP пакета
- Проверка получения ответа в течение таймаута (например, 2 секунды)

### 6. Нагрузочный тест

Создать `tests/LoadTest.test.ts`:

- Тест `should handle load test` - отправка множества параллельных запросов
- Использовать опцию `requestsPerSecond` из конфига
- Генерировать запросы с заданной частотой в течение `loadTestDuration`
- Измерять метрики: успешные/неуспешные запросы, среднее время ответа, пропускная способность
- Проверка, что процент успешных запросов > 95%

### 7. Обновление package.json

- Заменить скрипт `test` на `jest`
- Добавить скрипт `test:watch` для режима наблюдения
- Добавить скрипт `test:coverage` для покрытия кода

## Файлы для создания/изменения

**Новые файлы:**

- `jest.config.mjs` - конфигурация Jest
- `config/test.config.ini` - опции тестов
- `config/test.config.ini.dist` - шаблон опций тестов
- `src/Test/TestOptionsLoader.ts` - загрузчик опций тестов
- `src/Test/index.ts` - экспорт типов и функций для тестов
- `tests/App.test.ts` - тест доступности DNS-сервера
- `tests/LoadTest.test.ts` - нагрузочный тест

**Изменяемые файлы:**

- `package.json` - добавление зависимостей и скриптов

## Технические детали

### Использование dns-packet в тестах

Тесты будут использовать тот же `dns-packet`, что и основное приложение, для формирования DNS-запросов и парсинга ответов.

### Асинхронность

Оба теста будут асинхронными, так как работают с сетью. Использовать `async/await` и таймауты для Promise.

### Значение requestsPerSecond

Установлено значение 40 запросов/сек на основе статистики:

- Обычная работа веб-разработчика: 5-20 запросов/сек
- Активная разработка: 20-50 запросов/сек
- Выбрано среднее значение 40 запросов/сек для нагрузочного теста